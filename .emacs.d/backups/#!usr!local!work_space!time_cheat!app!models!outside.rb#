# -*- coding: utf-8 -*-
class Outside < ActiveRecord::Base
  after_validation :calc
  
  attr_accessible :ed, :holiday, :op, :rest_normal, :rest_overtime, :rest_late_night, :shift, :note
  belongs_to :user

  validates :shift, allow_blank: true,
  inclusion: { in: %w[A B C D E 休出] }
  
  validates :op, :ed, :rest_normal, :rest_overtime, :rest_late_night, :actual, :actual_late_night,
  presence: true,
  numericality: { only_integer: true },
  inclusion: { in: 0..(60 * 48) }
  
  validates :note, allow_nil: true,
  length: { maximum: 20 }

  private
  LATE_NIGHT_RANGE_START = 1320 # 深夜開始 22:00
  LATE_NIGHT_RANGE_END = 1740   # 深夜終了 29:00  

  def calc
    # 各カラムともself無しで呼び出しているが、actual_normalはselfに対して呼び出さないと計算結果がモデルインスタンスに代入されないみたい。
    # 実働 = 終業 - 始業 - 休憩1 - 休憩2 - 休憩深夜
    self.actual = ed - op - rest_normal - rest_overtime - rest_late_night

    # 実働(深夜)
    if ed < LATE_NIGHT_RANGE_START
      self.actual_late_night = 0
    else
      op > LATE_NIGHT_RANGE_START ? s = op : s = LATE_NIGHT_RANGE_START
      ed < LATE_NIGHT_RANGE_END ? e = ed : e = LATE_NIGHT_RANGE_END
      self.actual_late_night = e - s - rest_late_night  
    end
  end
end

